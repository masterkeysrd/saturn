---
openapi: 3.0.0

info:
  title: Saturn Personal Productivity Suite

servers:
  - url: http://localhost:3000
    description: Local server

paths:
  /finance/budgest:
    get:
      summary: List all budgets
      operationId: finance.ListBudgets
      responses:
        "200":
          description: Budgets list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListBudgetsResponse'
    post:
      summary: Create a new budget
      operationId: finance.CreateBudget
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Budget'
      responses:
        "201":
          description: Create budget
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Budget'

  /finance/budgest/{id}:
    get:
      summary: List all budgets
      operationId: finance.GetBudget
      parameters:
        - name: id
          in: path
          required: true
          description: Budget ID
          schema:
           type: string
      responses:
        "200":
          description: Budget
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Budget'
    patch:
      summary: Update a budget
      operationId: finance.UpdateBudget
      parameters:
      - name: id
        in: path
        required: true
        description: Budget ID
        schema:
          type: string
      - $ref: '#/components/parameters/UpdateMaskParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Budget'
      responses:
        "200":
          description: Update budget
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Budget'
    delete:
      summary: Delete a budget
      operationId: finance.DeleteBudget
      parameters:
      - name: id
        in: path
        required: true
        description: Budget ID
        schema:
          type: string
      responses:
        "204":
          description: Budget Updated

  /finance/currencies:
    get:
      summary: List currencies
      operationId: finance.ListCurrencies
      responses:
        "200":
          description: Currencies list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListCurrenciesResponse'
    post:
      summary: Create a new currency
      operationId: budget.CreateCurrency
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Currency'
      responses:
        "201":
          description: Create budget
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Currency'

  /finance/currencies/{code}:
    get:
      summary: Get a currency by currency code
      operationId: currency.get
      parameters:
      - name: code
        in: path
        required: true
        description: ISO currency code (e.g., USD, DOP, EUR)
        schema:
          type: string
      responses:
        "200":
          description: Currency
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Currency'


  /finance/expenses:
    post:
      summary: Create an expense (creates a transaction)
      operationId: finance.CreateExpense
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Expense'
      responses:
        "201":
          description: Transaction created from expense
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Transaction'

  finance/expenses/{id}:
    patch:
      summary: Update an expense (update a transaction)
      operationId: finance.UpdateExpense
      parameters:
      - name: id
        in: path
        required: true
        description: Transaction ID of the expense
        schema:
          type: string
      - $ref: '#/components/parameters/UpdateMaskParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Expense'
      responses:
        "200":
          description: Update transaction from expense
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Transaction'

  /finance/transactions/{id}:
    get:
      summary: Get transaction by ID
      operationId: finance.GetTransaction
      parameters:
        - in: path
          name: id
          schema:
            type: string
          description: Transaction ID
      responses:
        "200":
          description: Transaction
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Transaction'
    delete:
      summary: Delete transaction by ID
      operationId: finance.DeleteTransaction
      parameters:
        - in: path
          name: id
          schema:
            type: string
          description: Transaction ID
      responses:
        "204":
          description: Transaction deleted.


  /finance/transactions/:
    get:
      summary: List transactions
      operationId: finance.ListTransactions
      parameters:
        - in: query
          name: budget_id
          schema:
            type: string
          description: Filter by budget
        - in: query
          name: type
          schema:
            type: string
            enum: [expense, income, transfer]
          description: Filter by transaction type
      responses:
        "200":
          description: List of transactions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListTransactionsResponse'

  /finance/insights:
    get:
      operationId: finance.GetInsights
      summary: Get spending insights
      description: |
        Retrieves finance insights including expenses.

        Only support grouping data by month.
      tags:
        - Insights
      parameters:
        - name: start_date
          in: query
          required: true
          description: Start date for the insights period (ISO 8601 format)
          schema:
            type: string
            format: date
            example: "2025-05-01"
        - name: end_date
          in: query
          required: true
          description: End date for the insights period (ISO 8601 format)
          schema:
            type: string
            format: date
            example: "2025-11-16"
        - name: group_by
          in: query
          required: false
          description: Time period grouping for trends
          schema:
            type: string
            enum: [month]
            default: month
        - name: budget_ids
          in: query
          required: false
          description: Comma-separated list of budget IDs to filter
          schema:
            type: string
            example: "019a8ace-023e-77a1-a1ea-c16f24866b58,019a8ace-247c-7d93-b177-929c689de5e3"
          explode: false
      responses:
        '200':
          description: Spending insights retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FinanceInsights'

components:
  schemas:
    ListBudgetsResponse:
      type: object
      description: Response of list of budgets.
      required:
        - budgets
        - meta
      properties:
        budgets:
          type: array
          readOnly: true
          items:
            $ref: '#/components/schemas/BudgetItem'
        meta:
          $ref: '#/components/schemas/Meta'

    BudgetItem:
      type: object
      required:
        - id
        - name
        - color
        - icon_name
        - amount
        - spent
      properties:
        id:
          type: string
        name:
          type: string
          example: "Groceries"
        color:
          type: string
          description: The UI color code for the budget (Hex format).
          pattern: '^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$'
          example: "#2196f3"
        icon_name:
          type: string
          description: The identifier for the UI icon (e.g., Material Icon name).
          maxLength: 32
          example: "savings"
        amount:
          $ref: '#/components/schemas/Money'
        base_amount:
          $ref: '#/components/schemas/Money'
        spent:
          $ref: '#/components/schemas/Money'
          description: "Amount spent in budget currency"
        base_spent:
          $ref: '#/components/schemas/Money'
          description: "Amount spent in base currency"
        percentage:
          type: number
          format: double
          minimum: 0
          example: 65.5
          description: "Percentage of budget spent"
        transaction_count:
          type: integer
          minimum: 0
          example: 2
          description: "Number of transactions of the current period"
        period_start_date:
          type: string
          format: date
        period_end_date:
          type: string
          format: date

    Budget:
      type: object
      description: A budget to track expenses
      required:
        - name
        - amount
        - color
        - icon_name
      properties:
        id:
          type: string
          readOnly: true
        name:
          type: string
        amount:
          $ref: '#/components/schemas/Money'
        color:
          type: string
          description: The UI color code for the budget (Hex format).
          pattern: '^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$'
          example: "#2196f3"
        icon_name:
          type: string
          description: The identifier for the UI icon (e.g., Material Icon name).
          maxLength: 32
          example: "savings"

    ListCurrenciesResponse:
      type: object
      description: Response of list of currencies.
      required:
        - currencies
      properties:
        currencies:
          type: array
          readOnly: true
          items:
            $ref: '#/components/schemas/Currency'

    Currency:
      type: object
      description: A currency to handle exchange reates in budgets, transactions, etc.
      required:
        - name
        - code
        - rate
      properties:
        code:
          type: string
          description: ISO 4217 currency code (e.g., "USD", "DOP").
          minLength: 3
          maxLength: 3
          example: "DOP"
        name:
          type: string
          description: Name of the currency (e.g., "Dominican Pesos")
          minLenght: 3
          maxLenght: 50
          example: "Dominican Pesos"
        rate:
          type: number
          format: double
          description: The exchange rate for the currency againts the base currency.
          example: 60.50

    Expense:
      type: object
      description: |
        Represents the user-intent to record an expense.  
        The server will validate the expense, enrich it with currency data,
        and transform it into a Transaction.
      required:
        - budget_id
        - name
        - amount
        - date
      properties:
        id:
          type: string
          readOnly: true
          description: Generated UUID of the expense (same as transaction ID).
        budget_id:
          type: string
          description: ID of the budget to which this expense belongs.
          example: "2f0c9c26-1458-4f4c-b6e7-f6f93cfe98bc"
        name:
          type: string
          minLength: 3
          maxLength: 50
          description: Short name of the expense.
          example: "Phone Bill"
        description:
          type: string
          maxLength: 250
          nullable: true
          description: Optional longer description.
          example: "Monthly mobile phone payment"
        amount:
          type: integer
          format: int64
          description: The amount in the smallest denomination (e.g., cents).
          example: 400000
        exchange_rate:
          type: number
          format: double
          description: |
            Optional exchange rate for the expense.
            If not provided, the server will use the rate from the saved currency.
          example: 60.50
        date:
          type: string
          format: date
          description: The date when the expense occurred.
          example: "2025-02-01"
    
    Transaction:
      type: object
      description: |
        A fully-realized financial transaction stored in the ledger.
        Produced by Expense, Income, or Transfer operations.
      required:
        - name
        - type
        - amount
        - base_amount
        - exchange_rate
        - date
        - created_at
        - updated_at
      properties:
        id:
          type: string
          description: UUID of the transaction.
          example: "0b3d7d4d-6abf-4d2f-bcb3-7ddc947a53ea"
        type:
          $ref: '#/components/schemas/TransactionType'
        budget_id:
          type: string
          nullable: true
          description: Budget this transaction belongs to.
        name:
          type: string
          description: Copy of operation name.
        description:
          type: string
          nullable: true
        amount:
          $ref: '#/components/schemas/Money'
        base_amount:
          $ref: '#/components/schemas/Money'
          description: Value converted to the base currency.
        exchange_rate:
          type: number
          format: double
          description: Rate used to convert amount â†’ base_amount.
          example: 60.50
        date:
          type: string
          format: date
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ListTransactionsResponse:
      type: object
      description: Response containing a list of transactions.
      required:
        - transactions
      properties:
        transactions:
          type: array
          items:
            $ref: '#/components/schemas/Transaction'

    TransactionType:
      type: string
      enum:
        - expense
        - income
        - transfer
      description: Type of transaction.

    FinanceInsights:
      type: object
      required:
        - spending
        - meta
      properties:
        spending:
          $ref: '#/components/schemas/SpendingInsights'

    SpendingInsights:
      type: object
      required:
        - summary
        - by_budget
        - trends
      properties:
        summary:
          $ref: '#/components/schemas/SpendingSummary'
        by_budget:
          type: array
          description: Budget-level aggregates across all periods
          items:
            $ref: '#/components/schemas/SpendingBudgetSummary'
        trends:
          type: array
          description: Time-series data grouped by period
          items:
            $ref: '#/components/schemas/SpendingTrendPeriod'

    SpendingSummary:
      type: object
      required:
        - budgeted
        - spent
        - remaining
        - usage
        - count
      properties:
        spent:
          $ref: '#/components/schemas/Money'
        budgeted:
          $ref: '#/components/schemas/Money'
        remaining:
          $ref: '#/components/schemas/Money'
        usage:
          type: number
          format: double
          description: Percentage of budgeted amount spent (0-100)
          minimum: 0
          example: 72.5
        count:
          type: integer
          format: int32
          description: Total transactions in for this budget
          minimum: 0
          example: 25
    
    SpendingTrendPeriod:
      type: object
      required:
        - period
        - period_start
        - period_end
        - budgeted
        - spent
        - remaining
        - usage
        - count
        - budgets
      properties:
        period:
          type: string
          description: Period identifier (format depends on group_by parameter)
          example: "2025-11"
          pattern: '^\d{4}-\d{2}$'
        period_start:
          type: string
          format: date-time
          description: Start of the period in UTC
          example: "2025-11-01T00:00:00Z"
        period_end:
          type: string
          format: date-time
          description: End of the period in UTC
          example: "2025-11-30T23:59:59Z"
        budgeted:
          $ref: '#/components/schemas/Money'
        spent:
          $ref: '#/components/schemas/Money'
        remaining:
          $ref: '#/components/schemas/Money'
        usage:
          type: number
          format: double
          description: Percentage of budgeted amount spent for this period
          minimum: 0
          example: 72.5
        count:
          type: integer
          format: int32
          description: Total transactions in this period
          minimum: 0
          example: 25
        budgets:
          type: array
          description: Budget breakdown for this period
          items:
            $ref: '#/components/schemas/SpendingBudgetSummary'

    SpendingBudgetSummary:
      type: object
      required:
        - budget_id
        - budget_name
        - budget_icon_name
        - budget_color
        - budgeted
        - spent
        - remaining
        - usage
        - count
      properties:
        budget_id:
          type: string
          description: Unique identifier for the budget
          example: bdg_groceries
        budget_name:
          type: string
          description: Human-readable budget name
          minLength: 1
          maxLength: 100
          example: Groceries
        budget_color:
          type: string
          description: The UI color code for the budget (Hex format).
          pattern: '^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$'
          example: "#2196f3"
        budget_icon_name:
          type: string
          description: The identifier for the UI icon (e.g., Material Icon name).
          maxLength: 32
          example: "savings"
        budgeted:
          $ref: '#/components/schemas/Money'
        spent:
          $ref: '#/components/schemas/Money'
        remaining:
          $ref: '#/components/schemas/Money'
        usage:
          type: number
          format: double
          description: Percentage of budgeted amount spent (0-100)
          minimum: 0
          example: 65.0
        count:
          type: integer
          format: int32
          description: Total number of transactions
          minimum: 0
          example: 48

    FieldMask:
      type: array
      items:
        type: string
      description: |
        List of fields to update. If not provided, all fields will be updated.
        Supported fields: name, description, date, amount, exchange_rate
      example: ["name", "amount"]
      minItems: 0
      maxItems: 10

    Money:
      Money:
      type: object
      description: |
        Standard representation of a monetary value using minor units (cents) and ISO 4217 currency code.
      properties:
        cents:
          type: integer
          format: int64
          description: The amount in the smallest denomination (e.g., cents).
          example: 400000
        currency:
          type: string
          description: ISO 4217 currency code (e.g., "USD", "DOP").
          minLength: 3
          maxLength: 3
          example: "DOP"
      required:
        - cents
        - currency
    
    Meta:
      type: object
      description: Metadata regarding the pagination state of the response.
      required:
        - page
        - size
        - total_items
        - total_pages
        - has_next
        - has_previous
      properties:
        page:
          type: integer
          description: The current page number (1-based).
          example: 1
        size:
          type: integer
          description: The number of items per page.
          example: 20
        total_items:
          type: integer
          description: The total count of items matching the criteria across all pages.
          example: 45
        total_pages:
          type: integer
          description: The total number of pages available.
          example: 3
        has_next:
          type: boolean
          description: Indicates if there is a subsequent page of data.
          example: true
        has_previous:
          type: boolean
          description: Indicates if there is a preceding page of data.
          example: false

  parameters:
    UpdateMaskParam:
      name: updateMask
      in: query
      required: false
      description: |
        Comma-separated list of fields to update. If not provided, all fields will be updated.
        Supported fields: name, description, date, amount, exchange_rate
        
        Examples:
        - `name` - Update only name
        - `name,amount` - Update name and amount
        - `name,amount,exchange_rate` - Update multiple fields
      schema:
        type: string
        pattern: '^[a-z_]+(,[a-z_]+)*$'
      examples:
        single_field:
          summary: Update single field
          value: name
        multiple_fields:
          summary: Update multiple fields
          value: name,amount
        with_nested:
          summary: Update with nested field
          value: name,amount,exchange_rate
      style: form
      explode: false
